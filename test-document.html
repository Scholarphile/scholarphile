<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Viewing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
        }
        button {
            background: #3a7ca5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .log {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Document Viewing Test</h1>
    
    <div class="test-section">
        <h3>Test 1: Direct API Call</h3>
        <button onclick="testDirectAPI()">Test Direct API Call</button>
        <div id="log1" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Test 2: Fetch Document Content</h3>
        <button onclick="testFetchDocument()">Test Fetch Document</button>
        <div id="log2" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Test 3: Show Modal</h3>
        <button onclick="testShowModal()">Test Show Modal</button>
        <div id="log3" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Test 4: Full Document Opening</h3>
        <button onclick="testFullDocumentOpening()">Test Full Document Opening</button>
        <div id="log4" class="log"></div>
    </div>

    <script>
        const API_BASE_URL = 'https://scholarphile-api.scholarphile.workers.dev';
        const TEST_DOCUMENT_ID = 'edb4b684-86f2-4ce9-b5f0-495791b91ce0';

        function log(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent += new Date().toISOString() + ': ' + message + '\n';
            console.log(message);
        }

        // Test 1: Direct API call
        async function testDirectAPI() {
            const logElement = 'log1';
            log(logElement, 'Starting direct API test...');
            
            try {
                const url = `${API_BASE_URL}/api/documents/view?id=${TEST_DOCUMENT_ID}`;
                log(logElement, `Calling URL: ${url}`);
                
                const response = await fetch(url);
                log(logElement, `Response status: ${response.status}`);
                log(logElement, `Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`);
                
                if (response.ok) {
                    const content = await response.text();
                    log(logElement, `Content length: ${content.length}`);
                    log(logElement, `Content preview: ${content.substring(0, 100)}`);
                    log(logElement, '✅ Direct API test PASSED');
                } else {
                    log(logElement, `❌ API call failed: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                log(logElement, `❌ Error: ${error.message}`);
            }
        }

        // Test 2: Fetch document content
        async function testFetchDocument() {
            const logElement = 'log2';
            log(logElement, 'Starting fetch document test...');
            
            try {
                const documentUrl = `${API_BASE_URL}/api/documents/view?id=${TEST_DOCUMENT_ID}`;
                log(logElement, `Fetching from: ${documentUrl}`);
                
                const response = await fetch(documentUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const content = await response.text();
                log(logElement, `Document loaded successfully, length: ${content.length}`);
                log(logElement, '✅ Fetch document test PASSED');
                
                return { content, documentUrl };
            } catch (error) {
                log(logElement, `❌ Error: ${error.message}`);
                return null;
            }
        }

        // Test 3: Show modal
        function testShowModal() {
            const logElement = 'log3';
            log(logElement, 'Starting modal test...');
            
            try {
                // Remove existing modal if any
                const existingModal = document.getElementById('testModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'testModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 2rem;
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: #2a2a2a;
                    border-radius: 16px;
                    padding: 2rem;
                    max-width: 80%;
                    max-height: 80%;
                    overflow: auto;
                    border: 1px solid #333;
                `;

                modalContent.innerHTML = `
                    <h2>Test Modal</h2>
                    <p>This is a test modal to verify modal functionality.</p>
                    <button onclick="this.parentElement.parentElement.remove()">Close</button>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                log(logElement, '✅ Modal test PASSED');
            } catch (error) {
                log(logElement, `❌ Error: ${error.message}`);
            }
        }

        // Test 4: Full document opening
        async function testFullDocumentOpening() {
            const logElement = 'log4';
            log(logElement, 'Starting full document opening test...');
            
            try {
                // Step 1: Fetch document
                const result = await testFetchDocument();
                if (!result) {
                    log(logElement, '❌ Failed to fetch document');
                    return;
                }
                
                const { content, documentUrl } = result;
                
                // Step 2: Show modal
                showDocumentModal('Test Document', content, 'text/plain', documentUrl);
                
                log(logElement, '✅ Full document opening test PASSED');
            } catch (error) {
                log(logElement, `❌ Error: ${error.message}`);
            }
        }

        // Show document modal (copied from main app)
        function showDocumentModal(title, content, fileType, documentUrl) {
            // Remove existing modal if any
            const existingModal = document.getElementById('documentModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'documentModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #2a2a2a;
                border-radius: 16px;
                padding: 2rem;
                max-width: 90%;
                max-height: 90%;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                border: 1px solid #333;
            `;

            // Modal header
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid #333;
            `;
            
            const titleElement = document.createElement('h2');
            titleElement.textContent = title;
            titleElement.style.cssText = `
                margin: 0;
                color: white;
                font-size: 1.5rem;
                font-weight: 600;
            `;

            const closeButton = document.createElement('button');
            closeButton.innerHTML = '×';
            closeButton.style.cssText = `
                background: none;
                border: none;
                color: #ccc;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0.5rem;
                border-radius: 8px;
            `;
            closeButton.onclick = () => modal.remove();

            header.appendChild(titleElement);
            header.appendChild(closeButton);

            // Modal body
            const body = document.createElement('div');
            body.style.cssText = `
                flex: 1;
                overflow: auto;
                margin-bottom: 1rem;
            `;

            // Document content
            if (fileType && fileType.includes('text')) {
                // For text files, show content directly
                const textContent = document.createElement('pre');
                textContent.textContent = content;
                textContent.style.cssText = `
                    color: white;
                    font-family: monospace;
                    font-size: 0.875rem;
                    line-height: 1.5;
                    white-space: pre-wrap;
                    word-wrap: break-word;
                    margin: 0;
                    padding: 1rem;
                    background: #333;
                    border-radius: 8px;
                `;
                body.appendChild(textContent);
            } else {
                // For other files, show download option
                const downloadSection = document.createElement('div');
                downloadSection.style.cssText = `
                    text-align: center;
                    padding: 2rem;
                    color: #ccc;
                `;
                
                downloadSection.innerHTML = `
                    <h3 style="margin-bottom: 1rem; color: white;">Document Ready</h3>
                    <p style="margin-bottom: 2rem;">This document is ready for download.</p>
                    <button onclick="downloadDocument('${documentUrl}', '${title}')" style="
                        background: #3a7ca5;
                        color: white;
                        border: none;
                        padding: 0.75rem 1.5rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                    ">
                        Download Document
                    </button>
                `;
                body.appendChild(downloadSection);
            }

            modalContent.appendChild(header);
            modalContent.appendChild(body);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal on background click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // Download document function
        function downloadDocument(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html> 